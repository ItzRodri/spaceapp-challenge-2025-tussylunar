{% extends "base.html" %}

{% block title %}Basic Mode - Exoplanet AI Classifier{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-5 text-primary">
                <i class="fas fa-user"></i> Basic Mode
            </h1>
            <p class="lead">Quick exoplanet classification for individual candidates</p>
        </div>

        <!-- Input Form -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-edit"></i> Exoplanet Parameters</h4>
            </div>
            <div class="card-body">
                <form id="predictionForm">
                    <div class="row g-3">
                        <!-- Mission Selection -->
                        <div class="col-md-6">
                            <label for="mission" class="form-label">
                                Mission
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Select the space mission that observed this exoplanet candidate.">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <select class="form-select" id="mission" name="mission" required>
                                <option value="tess">TESS</option>
                                <option value="kepler">Kepler</option>
                            </select>
                            <div class="form-text">Select the mission that observed this candidate</div>
                        </div>

                        <!-- Target ID -->
                        <div class="col-md-6">
                            <label for="target_id" class="form-label">
                                Target ID (Optional)
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Identifier for the star or planet candidate. Examples: TOI-1234, KOI-5678.">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="text" class="form-control" id="target_id" name="target_id" 
                                   placeholder="e.g., TOI-1234 or KOI-5678">
                        </div>

                        <!-- Orbital Period -->
                        <div class="col-md-6">
                            <label for="orbital_period_days" class="form-label">
                                Orbital Period (days) <span class="text-danger">*</span>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Time taken by the planet to complete one orbit around its star.">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="number" class="form-control" id="orbital_period_days" 
                                   name="orbital_period_days" step="0.001" min="0.1" max="1000" required>
                            <div class="form-text">Range: 0.1 - 1000 days</div>
                        </div>
                        <!-- Transit Duration -->
                        <div class="col-md-6">
                            <label for="transit_duration_hours" class="form-label">
                                Transit Duration (hours) <span class="text-danger">*</span>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Time the planet takes to pass in front of its star.">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="number" class="form-control" id="transit_duration_hours" 
                                   name="transit_duration_hours" step="0.01" min="0.05" max="50" required>
                            <div class="form-text">Range: 0.05 - 50 hours</div>
                        </div>

                        <!-- Transit Depth -->
                        <div class="col-md-6">
                            <label for="transit_depth_ppm" class="form-label">
                                Transit Depth (ppm) <span class="text-danger">*</span>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Measure of how much the star's light dims during transit (parts per million).">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="number" class="form-control" id="transit_depth_ppm" 
                                   name="transit_depth_ppm" step="1" min="10" max="500000" required>
                            <div class="form-text">Range: 10 - 500,000 ppm</div>
                        </div>

                        <!-- Stellar Radius -->
                        <div class="col-md-6">
                            <label for="stellar_radius_solar" class="form-label">
                                Stellar Radius (solar) <span class="text-danger">*</span>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Radius of the host star in solar radii (1 = Sun's radius).">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="number" class="form-control" id="stellar_radius_solar" 
                                   name="stellar_radius_solar" step="0.01" min="0.1" max="100" required>
                            <div class="form-text">Range: 0.1 - 100 solar radii</div>
                        </div>

                        <!-- Stellar Temperature -->
                        <div class="col-md-6">
                            <label for="stellar_teff_K" class="form-label">
                                Stellar Temperature (K) <span class="text-danger">*</span>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Effective surface temperature of the host star in Kelvin.">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="number" class="form-control" id="stellar_teff_K" 
                                   name="stellar_teff_K" step="1" min="2000" max="15000" required>
                            <div class="form-text">Range: 2000 - 15000 K</div>
                        </div>

                        <!-- Signal-to-Noise Ratio -->
                        <div class="col-md-6">
                            <label for="snr" class="form-label">
                                Signal-to-Noise Ratio (Optional)
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="right" 
                                        title="Quality of the signal; higher values indicate more reliable measurements.">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <input type="number" class="form-control" id="snr" name="snr" 
                                   step="0.1" min="0" max="10000">
                            <div class="form-text">Range: 0 - 10,000</div>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="predictBtn">
                            <i class="fas fa-rocket"></i> Classify Exoplanet
                        </button>
                        <button type="reset" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="mt-4" style="display: none;">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-chart-line"></i> Classification Results</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Prediction -->
                        <div class="col-md-4">
                            <div class="text-center">
                                <h5>Prediction</h5>
                                <div id="prediction-badge" class="badge fs-4 p-3"></div>
                                <div id="confidence-badge" class="badge fs-6 mt-2"></div>
                            </div>
                        </div>

                        <!-- Probabilities -->
                        <div class="col-md-8">
                            <h5>Class Probabilities</h5>
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="confirmed-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                    <span id="confirmed-text">CONFIRMED: 0%</span>
                                </div>
                            </div>
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="candidate-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%">
                                    <span id="candidate-text">CANDIDATE: 0%</span>
                                </div>
                            </div>
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="false-positive-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%">
                                    <span id="false-positive-text">FALSE POSITIVE: 0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scientific Description -->
                    <div class="mt-4">
                        <h5><i class="fas fa-microscope"></i> Scientific Analysis</h5>
                        <div id="scientific-description"></div>
                    </div>

                    <!-- SHAP Explanations -->
                    <div class="mt-4">
                        <h5><i class="fas fa-brain"></i> Feature Importance (SHAP)</h5>
                        <div id="shap-explanations"></div>
                    </div>

                    <!-- Official Links -->
                    <div class="mt-4">
                        <h5><i class="fas fa-external-link-alt"></i> Official Resources</h5>
                        <div id="official-links"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center mt-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Analyzing exoplanet candidate...</p>
        </div>

        <!-- Error Alert -->
        <div id="error-alert" class="alert alert-danger mt-4" style="display: none;">
            <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
            <div id="error-message"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inicializar tooltips de Bootstrap
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})

document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    console.log('Form submitted!'); // Debug log
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    document.getElementById('error-alert').style.display = 'none';
    
    // Get form data
    const formData = new FormData(this);
    
    console.log('Form data:', Object.fromEntries(formData)); // Debug log
    
    try {
        const response = await fetch('/api/predict/single', {
            method: 'POST',
            body: formData
        });
        
        console.log('Response status:', response.status); // Debug log
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        console.log('Result:', result); // Debug log
        
        // Display results
        displayResults(result);
        
    } catch (error) {
        console.error('Error:', error); // Debug log
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('error-alert').style.display = 'block';
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
});

function displayResults(result) {
    console.log('Displaying results:', result); // Debug log
    
    // Update prediction badge
    const predictionBadge = document.getElementById('prediction-badge');
    predictionBadge.textContent = result.prediction;
    predictionBadge.className = 'badge fs-4 p-3 ';
    
    if (result.prediction === 'CONFIRMED') {
        predictionBadge.className += 'bg-success';
    } else if (result.prediction === 'CANDIDATE') {
        predictionBadge.className += 'bg-warning';
    } else {
        predictionBadge.className += 'bg-danger';
    }
    
    // Update confidence badge
    const confidenceBadge = document.getElementById('confidence-badge');
    confidenceBadge.textContent = `Confidence: ${result.confidence}`;
    confidenceBadge.className = 'badge fs-6 mt-2 ';
    
    if (result.confidence === 'HIGH') {
        confidenceBadge.className += 'bg-success';
    } else if (result.confidence === 'MEDIUM') {
        confidenceBadge.className += 'bg-warning';
    } else {
        confidenceBadge.className += 'bg-danger';
    }
    
    // Update probability bars
    updateProgressBar('confirmed', result.probas.CONFIRMED);
    updateProgressBar('candidate', result.probas.CANDIDATE);
    updateProgressBar('false-positive', result.probas.FALSE_POSITIVE);
    
    // Display scientific description
    displayScientificDescription(result.scientific_description);
    
    // Display SHAP explanations
    displaySHAPExplanations(result.explainability.shap_top5);
    
    // Display official links
    displayOfficialLinks(result.id, result.mission);
    
    // Show results
    document.getElementById('results').style.display = 'block';
}

function updateProgressBar(className, probability) {
    const percentage = Math.round(probability * 100);
    const bar = document.getElementById(`${className}-bar`);
    const text = document.getElementById(`${className}-text`);
    
    bar.style.width = `${percentage}%`;
    
    const classNames = {
        'confirmed': 'CONFIRMED',
        'candidate': 'CANDIDATE', 
        'false-positive': 'FALSE POSITIVE'
    };
    
    text.textContent = `${classNames[className]}: ${percentage}%`;
}

function displayScientificDescription(scientificDesc) {
    const container = document.getElementById('scientific-description');
    container.innerHTML = '';
    
    // Create main description card
    const mainCard = document.createElement('div');
    mainCard.className = 'card cosmic-glow';
    mainCard.style.background = 'linear-gradient(145deg, var(--space-deep) 0%, var(--space-medium) 100%)';
    mainCard.style.border = '2px solid var(--nebula-cyan)';
    mainCard.style.borderRadius = '20px';
    mainCard.style.padding = '1.5rem';
    mainCard.style.marginBottom = '1rem';
    
    mainCard.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-cosmic mb-3"><i class="fas fa-star"></i> Stellar Classification</h6>
                <p class="text-light">${scientificDesc.stellar_description}</p>
                
                <h6 class="text-cosmic mb-3 mt-4"><i class="fas fa-globe"></i> Planet Type</h6>
                <div class="planet-comparison">
                    <div class="planet-icon">${getPlanetIcon(scientificDesc.prediction)}</div>
                    <h5 class="text-center text-cosmic">${scientificDesc.planet_type.type}</h5>
                    <p class="text-center text-light">${scientificDesc.planet_type.description}</p>
                    <p class="text-center text-info">Estimated Radius: ${scientificDesc.estimated_radius.toFixed(2)} Earth radii</p>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-cosmic mb-3"><i class="fas fa-satellite"></i> Orbital Characteristics</h6>
                <p class="text-light">${scientificDesc.orbital_description}</p>
                
                <h6 class="text-cosmic mb-3 mt-4"><i class="fas fa-cloud"></i> Atmospheric Analysis</h6>
                <p class="text-light">${scientificDesc.atmospheric_description}</p>
                
                <h6 class="text-cosmic mb-3 mt-4"><i class="fas fa-heart"></i> Habitability Assessment</h6>
                <div class="alert ${getHabitabilityAlertClass(scientificDesc.habitability.score)}">
                    <strong>${scientificDesc.habitability.score} Habitability</strong><br>
                    ${scientificDesc.habitability.explanation}
                </div>
            </div>
        </div>
        
        <hr style="border-color: var(--nebula-cyan);">
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h6 class="text-cosmic mb-3"><i class="fas fa-question-circle"></i> Why This Classification?</h6>
                <p class="text-light">${scientificDesc.why_explanation}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-cosmic mb-3"><i class="fas fa-balance-scale"></i> Similar to ${scientificDesc.similar_planet.name}</h6>
                <p class="text-light">${scientificDesc.similar_planet.description}</p>
                <div class="mt-2">
                    ${scientificDesc.similar_planet.characteristics.map(char => 
                        `<span class="badge bg-info me-1 mb-1">${char}</span>`
                    ).join('')}
                </div>
            </div>
        </div>
        
        ${scientificDesc.scientific_notes.length > 0 ? `
        <div class="mt-4">
            <h6 class="text-cosmic mb-3"><i class="fas fa-sticky-note"></i> Scientific Notes</h6>
            <ul class="text-light">
                ${scientificDesc.scientific_notes.map(note => `<li>${note}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
    `;
    
    container.appendChild(mainCard);
}

function getPlanetIcon(prediction) {
    switch(prediction) {
        case 'CONFIRMED': return '🪐';
        case 'CANDIDATE': return '🔍';
        case 'FALSE_POSITIVE': return '❌';
        default: return '🌌';
    }
}

function getHabitabilityAlertClass(score) {
    switch(score) {
        case 'High': return 'alert-success';
        case 'Medium': return 'alert-warning';
        case 'Low': return 'alert-danger';
        case 'Very Low': return 'alert-danger';
        default: return 'alert-info';
    }
}

function displaySHAPExplanations(shapData) {
    const container = document.getElementById('shap-explanations');
    container.innerHTML = '';
    
    shapData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'row mb-2';
        
        const impact = item.shap > 0 ? 'positive' : 'negative';
        const impactClass = item.shap > 0 ? 'text-success' : 'text-danger';
        const impactIcon = item.shap > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        
        div.innerHTML = `
            <div class="col-md-4">
                <strong>${item.feature.replace(/_/g, ' ').toUpperCase()}</strong>
            </div>
            <div class="col-md-3">
                Value: ${item.value.toFixed(3)}
            </div>
            <div class="col-md-3 ${impactClass}">
                <i class="fas ${impactIcon}"></i> Impact: ${item.shap.toFixed(3)}
            </div>
            <div class="col-md-2">
                <span class="badge bg-${impact === 'positive' ? 'success' : 'danger'}">
                    ${impact.toUpperCase()}
                </span>
            </div>
        `;
        
        container.appendChild(div);
    });
}

function displayOfficialLinks(id, mission) {
    const container = document.getElementById('official-links');
    container.innerHTML = '';
    
    if (id && id.startsWith('TOI-')) {
        const toiNumber = id.replace('TOI-', '');
        container.innerHTML = `
            <a href="https://exoplanetarchive.ipac.caltech.edu/overview/${id}" 
               target="_blank" class="btn btn-outline-primary me-2">
                <i class="fas fa-external-link-alt"></i> NASA Exoplanet Archive
            </a>
            <a href="https://tess.mit.edu/observations/${toiNumber}" 
               target="_blank" class="btn btn-outline-info">
                <i class="fas fa-satellite"></i> TESS Mission
            </a>
        `;
    } else if (id && id.startsWith('KOI-')) {
        container.innerHTML = `
            <a href="https://exoplanetarchive.ipac.caltech.edu/overview/${id}" 
               target="_blank" class="btn btn-outline-primary me-2">
                <i class="fas fa-external-link-alt"></i> NASA Exoplanet Archive
            </a>
            <a href="https://www.nasa.gov/mission_pages/kepler/main/index.html" 
               target="_blank" class="btn btn-outline-warning">
                <i class="fas fa-satellite"></i> Kepler Mission
            </a>
        `;
    } else {
        container.innerHTML = `
            <p class="text-muted">
                <i class="fas fa-info-circle"></i> 
                No specific links available for this prediction ID.
            </p>
        `;
    }
}

// Debug: Add click listener to button
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('predictBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            console.log('Button clicked!'); // Debug log
        });
    }
});
</script>
{% endblock %}
